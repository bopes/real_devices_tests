{"version":3,"sources":["../src/local.js"],"names":["Local","options","BrowserstackMock","assign","browserstack","Promise","resolve","reject","key","user","prefix","localIdentifier","localKey","connectFailures","log","connect","logFilePath","tempDir","localOptions","verbose","debug","logFile","forceLocal","JSON","stringify","start","err","message","BAILED","Error","MAX_CONNECT_RETRIES","then","catch","stop"],"mappings":";;;;;;;;AAAA;;;;AACA;;AACA;;;;AAEA;;;;AACA;;;;;;;;IAEqBA,K;AACnB,iBAAYC,OAAZ,EAA8C;AAAA,QAAzBC,gBAAyB,uEAAN,IAAM;;AAAA;;AAC5C,SAAKD,OAAL,GAAe,iBAAEE,MAAF,CAAS,EAAT,EAAaF,OAAb,CAAf;AACA,SAAKG,YAAL,GAAoB,8BAApB;;AAEA,QAAIF,gBAAJ,EAAsB;AACpB,WAAKE,YAAL,GAAoBF,gBAApB;AACD;AACF;;;;iCAEY;AAAA;;AACX,aAAO,IAAIG,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,YAAI,CAAC,MAAKN,OAAL,CAAaO,GAAlB,EAAuB;AACrB,iBAAOD,OAAO,0CACV,0CADG,CAAP;AAED;;AAED,YAAI,CAAC,MAAKN,OAAL,CAAaQ,IAAlB,EAAwB;AACtB,iBAAOF,OAAO,0CACV,2CADG,CAAP;AAED;;AAED,eAAOD,SAAP;AACD,OAZM,CAAP;AAaD;;;2BAEM;AAAA;;AACL,iCAAOI,MAAP,GAAgB,uBAAhB;AACA,UAAMC,kBAAkB,KAAKV,OAAL,CAAaU,eAArC;AACA,UAAMC,WAAW,KAAKX,OAAL,CAAaO,GAA9B;AACA,UAAIK,kBAAkB,CAAtB;;AAEA,iCAAOC,GAAP,0CAAkDH,eAAlD;;AAEA,UAAMI,UAAU,SAAVA,OAAU,GAAM;AACpB,eAAO,IAAIV,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,cAAMS,cAAiB,eAAKV,OAAL,CAAa,mBAASW,OAAtB,CAAjB,eACJN,eADI,2BAAN;AAEA,cAAMO,eAAe;AACnBV,iBAAKI,QADc;AAEnBD,4CAFmB;;AAInBQ,qBAAS,mBAASC,KAJC;AAKnBC,qBAASL,WALU;AAMnBM,wBAAY;AANO,WAArB;;AASA,qCAAOF,KAAP,4CAAsDG,KAAKC,SAAL,CAAeN,YAAf,CAAtD;;AAEA,iBAAKd,YAAL,CAAkBqB,KAAlB,CAAwBP,YAAxB,EAAsC,UAACQ,GAAD,EAAS;AAC7C,gBAAIA,GAAJ,EAAS;AACP,yCAAON,KAAP,CAAa,wCAAb;AACA,yCAAOA,KAAP,CAAaM,IAAIC,OAAjB;;AAEA,kBAAI,mBAASC,MAAb,EAAqB;AACnBf;;AAEA,uBAAON,OAAO,IAAIsB,KAAJ,CAAU,qCACpB,+BADU,CAAP,CAAP;AAED,eALD,MAKO;AACLhB;;AAEA,oBAAIA,mBAAmB,mBAASiB,mBAAhC,EAAqD;AACnD,qCAASF,MAAT,GAAkB,IAAlB;AACA,yBAAOrB,OAAO,IAAIsB,KAAJ,CAAU,sEACHhB,eADG,gBAAV,CAAP,CAAP;AAED,iBAJD,MAIO;AACL;AACA,6CAAOa,GAAP,CAAW,sDAAoDb,eAApD,aACA,mBAASiB,mBADT,kBAAX;;AAGA,yBAAOf,UACJgB,IADI,CACCzB,OADD,EAEJ0B,KAFI,CAEEzB,MAFF,CAAP;AAGD;AAEF;AACF,aA3BD,MA2BO;AACL,qBAAOD,SAAP;AACD;AACF,WA/BD;AAgCD,SA9CM,CAAP;AA+CD,OAhDD;;AAkDA,aAAOS,SAAP;AACD;;;4BAEO;AAAA;;AACN,iCAAOL,MAAP,GAAgB,uBAAhB;AACA,aAAO,IAAIL,OAAJ,CAAY,UAACC,OAAD,EAAa;AAC9B,mCAAOQ,GAAP,0CAAkD,OAAKb,OAAL,CAAaU,eAA/D;AACA,eAAKP,YAAL,CAAkB6B,IAAlB,CAAuB,YAAM;AAC3B3B;AACD,SAFD;AAGD,OALM,CAAP;AAMD;;;;;;kBA/FkBN,K","file":"local.js","sourcesContent":["import path from \"path\";\nimport { Local as Browserstack } from \"browserstack-local\";\nimport _ from \"lodash\";\n\nimport settings from \"./settings\";\nimport logger from \"testarmada-logger\";\n\nexport default class Local {\n  constructor(options, BrowserstackMock = null) {\n    this.options = _.assign({}, options);\n    this.browserstack = new Browserstack();\n\n    if (BrowserstackMock) {\n      this.browserstack = BrowserstackMock;\n    }\n  }\n\n  initialize() {\n    return new Promise((resolve, reject) => {\n      if (!this.options.key) {\n        return reject(\"Browserstack local tunnel support is \"\n          + \"missing configuration: Browserstack key.\");\n      }\n\n      if (!this.options.user) {\n        return reject(\"Browserstack local tunnel support is \"\n          + \"missing configuration: Browserstack user.\");\n      }\n\n      return resolve();\n    });\n  }\n\n  open() {\n    logger.prefix = \"Browserstack Executor\";\n    const localIdentifier = this.options.localIdentifier;\n    const localKey = this.options.key;\n    let connectFailures = 0;\n\n    logger.log(`Opening browserstack local connect [${localIdentifier}]`);\n\n    const connect = () => {\n      return new Promise((resolve, reject) => {\n        const logFilePath = `${path.resolve(settings.tempDir)}/build-${\n          localIdentifier}_browserstacklocal.log`;\n        const localOptions = {\n          key: localKey,\n          localIdentifier,\n\n          verbose: settings.debug,\n          logFile: logFilePath,\n          forceLocal: true\n        };\n\n        logger.debug(`calling browserstack local.start() w/ ${JSON.stringify(localOptions)}`);\n\n        this.browserstack.start(localOptions, (err) => {\n          if (err) {\n            logger.debug(\"Error from browserstack local.start():\");\n            logger.debug(err.message);\n\n            if (settings.BAILED) {\n              connectFailures++;\n\n              return reject(new Error(\"Bailed due to maximum number of \"\n                + \"browsetstack connect retries.\"));\n            } else {\n              connectFailures++;\n\n              if (connectFailures >= settings.MAX_CONNECT_RETRIES) {\n                settings.BAILED = true;\n                return reject(new Error(\"Failed to create a secure browserstack local \"\n                  + `connect after ${connectFailures} attempts.`));\n              } else {\n                // Otherwise, keep retrying, and hope this is merely a blip and not an outage.\n                logger.err(`>>> Browserstack Local Connect Failed!  Retrying ${connectFailures}`\n                  + ` of ${settings.MAX_CONNECT_RETRIES} attempts...`);\n\n                return connect()\n                  .then(resolve)\n                  .catch(reject);\n              }\n\n            }\n          } else {\n            return resolve();\n          }\n        });\n      });\n    };\n\n    return connect();\n  }\n\n  close() {\n    logger.prefix = \"Browserstack Executor\";\n    return new Promise((resolve) => {\n      logger.log(`Closing browserstack local connect [${this.options.localIdentifier}]`);\n      this.browserstack.stop(() => {\n        resolve();\n      });\n    });\n  }\n}\n"]}